- name: Install Packages
  hosts: all
  become: true
  tasks:
  
    - name: Install utility packages
      apt:
        name: "{{ packages }}"
        state: present
      vars:
        packages:
            - apt-transport-https
            - ca-certificates        
            - curl
            - wget
            - gnupg-agent
            - software-properties-common            

- name: Local DNS
  hosts: all
  gather_facts: yes
  tasks:

    - name: Update /etc/hosts file with node name
      tags: etchostsupdate
      become: yes
      become_user: root
      lineinfile:
        path: "/etc/hosts"
        regexp: ".*\t{{ hostvars[item]['ansible_fqdn']}}\t{{ hostvars[item]['ansible_hostname']}}"
        line: "{{ hostvars[item]['ansible_eth1'].ipv4.address }}\t{{ hostvars[item]['ansible_fqdn']}}\t{{ hostvars[item]['ansible_hostname']}}"
        state: present
        backup: yes
      register: etchostsupdate
      when: ansible_hostname != "{{ item }}" or ansible_hostname == "{{ item }}"
      with_items: "{{groups['all']}}"
    
    - name: Patch /etc/hosts 
      become: true
      shell: | 
        sed -i s/"127.0.2.1 {{ ansible_facts['fqdn']}} {{ ansible_facts['hostname']}}"/""/ /etc/hosts

- name: Copy s3gw resources
  hosts: all
  tasks:

    - name: Copy s3gw cfg to local dir
      copy: src=../s3gw dest=/home/vagrant mode=0777

    - name: Set S3GW_IMAGE in s3gw-deployment.yaml
      replace:
        path: /home/vagrant/s3gw/s3gw-deployment.yaml
        regexp: '##S3GW_IMAGE##'
        replace: "{{ s3gw_image }}"

- name: Copy ingress resources
  hosts: all
  tasks:
    - name: Copy nginx ingresses cfg to local dir
      copy: src=../ingress-nginx dest=/home/vagrant mode=0777

    - name: Copy traefik ingresses cfg to local dir
      copy: src=../ingress-traefik dest=/home/vagrant mode=0777

- name: Copy k3s scripts
  hosts: all
  tasks:

    - name: Copy setup_k3s.sh to local dir
      copy: src=../setup_k3s.sh dest=/home/vagrant mode=0777

    - name: Copy generate-spec.sh to local dir
      copy: src=../generate-spec.sh dest=/home/vagrant mode=0777

- name: Run k3s scripts
  hosts: all
  become: true 
  tasks:

    - name: Run setup_k3s.sh
      command: /bin/bash -c "/home/vagrant/setup_k3s.sh"
      retries: 3
      delay: 2
      register: result
      until: result.rc == 0

    - name: Setting kubectl alias and enabling kubectl bash completion
      command: "{{ item }}"
      with_items:
          - /bin/bash -c "sudo echo 'source <(kubectl completion bash)' >> /home/vagrant/.bashrc"
          - /bin/bash -c "sudo touch /etc/bash_completion.d/kubectl"
          - /bin/bash -c "sudo chmod 777 /etc/bash_completion.d/kubectl"
          - /bin/bash -c "kubectl completion bash > /etc/bash_completion.d/kubectl"
          - /bin/bash -c "sudo echo 'alias k=kubectl' >> /home/vagrant/.bashrc"
          - /bin/bash -c "sudo echo 'complete -F __start_kubectl k' >> /home/vagrant/.bashrc"
