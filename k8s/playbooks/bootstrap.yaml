- name: bootstrap-1
  hosts: all
  become: true
  tasks:
  
    - name: Install utility packages
      apt:
        name: "{{ packages }}"
        state: present
      vars:
        packages:
            - apt-transport-https
            - ca-certificates        
            - curl
            - wget
            - gnupg-agent
            - software-properties-common            

- name: bootstrap-2
  hosts: all
  become: true
  tasks:

    - name: Add signing key for Docker's repository
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add repository for Docker stable version
      apt_repository:
        repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable
        state: present

    - name: Install Docker
      apt: 
        name: "{{ packages }}"
        state: present
        update_cache: yes
      vars:
        packages:
            - docker-ce 
            - docker-ce-cli 
            - docker-compose
            - containerd.io

    - name: Patching daemon.json
      copy:
        dest: "/etc/docker/daemon.json"
        content: |
            {
            "exec-opts": ["native.cgroupdriver=systemd"],
            "insecure-registries" : ["admin:5000"]
            }
            
    - name: Restart Docker
      service:
        name: docker
        state: restarted
        daemon_reload: yes

    - name: Add vagrant user to Docker group
      user:
        name: vagrant
        group: docker

    - name: Remove swapfile from /etc/fstab
      mount:
        name: "{{ item }}"
        fstype: swap
        state: absent
      with_items:
        - swap
        - none
    
    - name: Disable swap
      command: swapoff -a

- name: bootstrap-3
  hosts: admins
  become: yes
  tasks:

    - name: Start a local registry
      command: docker run -d -p 5000:5000 --restart=always --name registry registry:2

    - name: Copy host's s3gw container image to local dir
      copy: src=../s3gw.tar dest=/home/vagrant mode=0777

    - name: Import s3gw container into local registry
      command: "{{ item }}"
      with_items:
        - docker load --input s3gw.tar
        - docker tag s3gw admin:5000/s3gw
        - docker push admin:5000/s3gw
        - docker image rm s3gw
        - docker image rm admin:5000/s3gw
        - rm -rf s3gw.tar

- name: bootstrap-4
  hosts: all
  gather_facts: yes
  tasks:

    - name: Update /etc/hosts file with node name
      tags: etchostsupdate
      become: yes
      become_user: root
      lineinfile:
        path: "/etc/hosts"
        regexp: ".*\t{{ hostvars[item]['ansible_fqdn']}}\t{{ hostvars[item]['ansible_hostname']}}"
        line: "{{ hostvars[item]['ansible_eth1'].ipv4.address }}\t{{ hostvars[item]['ansible_fqdn']}}\t{{ hostvars[item]['ansible_hostname']}}"
        state: present
        backup: yes
      register: etchostsupdate
      when: ansible_hostname != "{{ item }}" or ansible_hostname == "{{ item }}"
      with_items: "{{groups['all']}}"
    
    - name: Patch /etc/hosts 
      become: true
      shell: | 
        sed -i s/"127.0.2.1 {{ ansible_facts['fqdn']}} {{ ansible_facts['hostname']}}"/""/ /etc/hosts
